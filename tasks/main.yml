---

- name: Insure Required Packages Are Installed
  package:
    name: "{{ item }}"
    state: installed
  with_items:
    - tar
    - wget
    - gcc
    - make
    - perl

- name: Check OpenSSL Install State
  register: __openssl_version
  ignore_errors: true
  changed_when: false
  shell: >
    openssl version

- name: Set Installed
  set_fact:
    __openssl_installed: "{% if __openssl_version|failed or __openssl_version.stdout != openssl_version %}true{% else %}false{% endif %}"

- name: Create Temporary Storage Location
  when: not __openssl_installed
  file:
    state: directory
    path: "{{ openssl_tmp_storage }}"

- name: Download OpenSSL
  when: not __openssl_installed
  get_url:
    dest: "{{ openssl_tmp_storage }}"
    url: "{{ openssl_download_location }}"
    checksum: "{{ openssl_version_specific[openssl_version].checksum }}"

- name: Unpack OpenSSL
  when: not __openssl_installed
  unarchive:
    remote_src: yes
    src: "{{ openssl_tmp_storage }}/{{ openssl_tar_archive }}"
    dest: "{{ openssl_tmp_storage }}"
    keep_newer: yes

- name: Configure OpenSSL
  when: not __openssl_installed
  register: __openssl_configure
  command: >
    ./config -Wl,--enable-new-dtags,-rpath,'$(LIBRPATH)'
    chdir={{ openssl_tmp_storage }}/{{ openssl_name}}

- name: Debug Output of Configure OpenSSL
  debug: var=__openssl_configure.stdout_lines
  when:
    - openssl_debug
    - not __openssl_installed

- name: Make OpenSSL
  when: not __openssl_installed
  register: __openssl_make
  make:
    chdir: "{{ openssl_tmp_storage }}/{{ openssl_name }}"

- name: Debug Output of Make OpenSSL
  debug: var=__openssl_make.stdout_lines
  when:
    - openssl_debug
    - not __openssl_installed

- name: Make Test OpenSSL
  when: not __openssl_installed
  register: __openssl_make_test
  ignore_errors: true
  make:
    chdir: "{{ openssl_tmp_storage }}/{{ openssl_name }}"
    target: test

- name: Debug Output of Make Install OpenSSL
  debug: var=__openssl_make_test.stdout_lines
  when:
    - openssl_debug
    - not __openssl_installed

- name: Make Install OpenSSL
  when: not __openssl_installed
  register: __openssl_make_install
  make:
    chdir: "{{ openssl_tmp_storage }}/{{ openssl_name }}"
    target: install
  become: yes

- name: Debug Output of Make Install OpenSSL
  debug: var=__openssl_make_install.stdout_lines
  when:
    - openssl_debug
    - not __openssl_installed
